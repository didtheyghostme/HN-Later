var background=(function(){"use strict";function x(t){return t==null||typeof t=="function"?{main:t}:t}const f=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,h=(t,e)=>e.some(n=>t instanceof n);let C,P;function O(){return C||(C=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return P||(P=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const y=new WeakMap,I=new WeakMap,m=new WeakMap;function L(t){const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",i)},o=()=>{n(u(t.result)),r()},i=()=>{s(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",i)});return m.set(e,t),e}function _(t){if(y.has(t))return;const e=new Promise((n,s)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",i),t.removeEventListener("abort",i)},o=()=>{n(),r()},i=()=>{s(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",i),t.addEventListener("abort",i)});y.set(t,e)}let b={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return y.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function A(t){b=t(b)}function j(t){return V().includes(t)?function(...e){return t.apply(g(this),e),u(this.request)}:function(...e){return u(t.apply(g(this),e))}}function R(t){return typeof t=="function"?j(t):(t instanceof IDBTransaction&&_(t),h(t,O())?new Proxy(t,b):t)}function u(t){if(t instanceof IDBRequest)return L(t);if(I.has(t))return I.get(t);const e=R(t);return e!==t&&(I.set(t,e),m.set(e,t)),e}const g=t=>m.get(t);function F(t,e,{blocked:n,upgrade:s,blocking:r,terminated:o}={}){const i=indexedDB.open(t,e),l=u(i);return s&&i.addEventListener("upgradeneeded",a=>{s(u(i.result),a.oldVersion,a.newVersion,u(i.transaction),a)}),n&&i.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),l.then(a=>{o&&a.addEventListener("close",()=>o()),r&&a.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const N=["get","getKey","getAll","getAllKeys","count"],W=["put","add","delete","clear"],p=new Map;function k(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(p.get(e))return p.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,r=W.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||N.includes(n)))return;const o=async function(i,...l){const a=this.transaction(i,r?"readwrite":"readonly");let d=a.store;return s&&(d=d.index(l.shift())),(await Promise.all([d[n](...l),r&&a.done]))[0]};return p.set(e,o),o}A(t=>({...t,get:(e,n,s)=>k(e,n)||t.get(e,n,s),has:(e,n)=>!!k(e,n)||t.has(e,n)}));const $=["continue","continuePrimaryKey","advance"],M={},D=new WeakMap,v=new WeakMap,K={get(t,e){if(!$.includes(e))return t[e];let n=M[e];return n||(n=M[e]=function(...s){D.set(this,v.get(this)[e](...s))}),n}};async function*G(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,K);for(v.set(n,e),m.set(n,g(e));e;)yield n,e=await(D.get(n)||e.continue()),D.delete(n)}function S(t,e){return e===Symbol.asyncIterator&&h(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&h(t,[IDBIndex,IDBObjectStore])}A(t=>({...t,get(e,n,s){return S(e,n)?G:t.get(e,n,s)},has(e,n){return S(e,n)||t.has(e,n)}}));let E=null;function c(){return E||(E=F("hn-later",2,{upgrade(t,e){e<1&&t.createObjectStore("stories",{keyPath:"id"}).createIndex("by-savedAt","savedAt")}})),E}async function U(t){const e=await c(),n=await e.get("stories",t.id);n?await e.put("stories",{...n,...t,lastVisit:Date.now()}):await e.add("stories",{...t,savedAt:Date.now(),lastVisit:Date.now(),checkpointCommentId:null,checkpointTimestamp:Date.now()})}async function H(t){await(await c()).delete("stories",t)}async function J(t){return(await c()).get("stories",t)}async function T(){return(await(await c()).getAllFromIndex("stories","by-savedAt")).reverse()}async function X(t){return!!await(await c()).get("stories",t)}async function z(t,e,n){const s=await c(),r=await s.get("stories",t);r&&await s.put("stories",{...r,checkpointCommentId:e,checkpointTimestamp:Date.now(),totalComments:n,lastVisit:Date.now()})}async function Q(t){const n=await(await c()).get("stories",t);return n?{checkpointCommentId:n.checkpointCommentId,checkpointTimestamp:n.checkpointTimestamp,totalComments:n.totalComments}:null}async function Y(){const t=await T();return JSON.stringify({version:2,stories:t},null,2)}async function Z(t){const e=JSON.parse(t);if(!e.version||!Array.isArray(e.stories))throw new Error("Invalid backup format");const n=await c();let s=0;for(const r of e.stories){const o={id:r.id,title:r.title,url:r.url,hnUrl:r.hnUrl,savedAt:r.savedAt,lastVisit:r.lastVisit,totalComments:r.totalComments||0,checkpointCommentId:r.checkpointCommentId||null,checkpointTimestamp:r.checkpointTimestamp||null};await n.put("stories",o),s++}return s}const q=x(()=>{async function t(){try{const n=(await T()).length;await f.action.setBadgeText({text:n>0?String(n):""}),await f.action.setBadgeBackgroundColor({color:"#ff6600"})}catch(e){console.error("Failed to update badge:",e)}}t(),f.runtime.onMessage.addListener((e,n,s)=>((async()=>{try{switch(e.type){case"SAVE_ITEM":return await U(e.item),await t(),{success:!0};case"REMOVE_ITEM":return await H(e.storyId),await t(),{success:!0};case"GET_ITEMS":return{success:!0,items:await T()};case"GET_ITEM":return{success:!0,item:await J(e.storyId)};case"IS_SAVED":return{success:!0,saved:await X(e.storyId)};case"UPDATE_CHECKPOINT":return await z(e.storyId,e.checkpointCommentId,e.totalComments),{success:!0};case"GET_PROGRESS":return{success:!0,progress:await Q(e.storyId)};case"EXPORT_DATA":return{success:!0,data:await Y()};case"IMPORT_DATA":{const o=await Z(e.json);return await t(),{success:!0,count:o}}case"OPEN_THREAD":return await f.tabs.create({url:`${e.url}#hn-later-continue`}),{success:!0};default:return{success:!1,error:"Unknown message type"}}}catch(o){return console.error("Message handler error:",o),{success:!1,error:String(o)}}})().then(s),!0))});function nt(){}function w(t,...e){}const tt={debug:(...t)=>w(console.debug,...t),log:(...t)=>w(console.log,...t),warn:(...t)=>w(console.warn,...t),error:(...t)=>w(console.error,...t)};let B;try{B=q.main(),B instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw tt.error("The background crashed on startup!"),t}return B})();

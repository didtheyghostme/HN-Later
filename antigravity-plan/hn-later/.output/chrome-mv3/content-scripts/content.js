var content=(function(){"use strict";function vt(t){return t}const y=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,S=(t,e)=>e.some(n=>t instanceof n);let k,N;function Y(){return k||(k=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function G(){return N||(N=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const E=new WeakMap,C=new WeakMap,w=new WeakMap;function J(t){const e=new Promise((n,s)=>{const o=()=>{t.removeEventListener("success",r),t.removeEventListener("error",i)},r=()=>{n(h(t.result)),o()},i=()=>{s(t.error),o()};t.addEventListener("success",r),t.addEventListener("error",i)});return w.set(e,t),e}function z(t){if(E.has(t))return;const e=new Promise((n,s)=>{const o=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",i),t.removeEventListener("abort",i)},r=()=>{n(),o()},i=()=>{s(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",r),t.addEventListener("error",i),t.addEventListener("abort",i)});E.set(t,e)}let L={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return E.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function R(t){L=t(L)}function Q(t){return G().includes(t)?function(...e){return t.apply(T(this),e),h(this.request)}:function(...e){return h(t.apply(T(this),e))}}function X(t){return typeof t=="function"?Q(t):(t instanceof IDBTransaction&&z(t),S(t,Y())?new Proxy(t,L):t)}function h(t){if(t instanceof IDBRequest)return J(t);if(C.has(t))return C.get(t);const e=X(t);return e!==t&&(C.set(t,e),w.set(e,t)),e}const T=t=>w.get(t);function Z(t,e,{blocked:n,upgrade:s,blocking:o,terminated:r}={}){const i=indexedDB.open(t,e),c=h(i);return s&&i.addEventListener("upgradeneeded",a=>{s(h(i.result),a.oldVersion,a.newVersion,h(i.transaction),a)}),n&&i.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{r&&a.addEventListener("close",()=>r()),o&&a.addEventListener("versionchange",l=>o(l.oldVersion,l.newVersion,l))}).catch(()=>{}),c}const tt=["get","getKey","getAll","getAllKeys","count"],et=["put","add","delete","clear"],D=new Map;function V(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(D.get(e))return D.get(e);const n=e.replace(/FromIndex$/,""),s=e!==n,o=et.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(o||tt.includes(n)))return;const r=async function(i,...c){const a=this.transaction(i,o?"readwrite":"readonly");let l=a.store;return s&&(l=l.index(c.shift())),(await Promise.all([l[n](...c),o&&a.done]))[0]};return D.set(e,r),r}R(t=>({...t,get:(e,n,s)=>V(e,n)||t.get(e,n,s),has:(e,n)=>!!V(e,n)||t.has(e,n)}));const nt=["continue","continuePrimaryKey","advance"],F={},M=new WeakMap,O=new WeakMap,st={get(t,e){if(!nt.includes(e))return t[e];let n=F[e];return n||(n=F[e]=function(...s){M.set(this,O.get(this)[e](...s))}),n}};async function*rt(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,st);for(O.set(n,e),w.set(n,T(e));e;)yield n,e=await(M.get(n)||e.continue()),M.delete(n)}function U(t,e){return e===Symbol.asyncIterator&&S(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&S(t,[IDBIndex,IDBObjectStore])}R(t=>({...t,get(e,n,s){return U(e,n)?rt:t.get(e,n,s)},has(e,n){return U(e,n)||t.has(e,n)}}));let B=null;function f(){return B||(B=Z("hn-later",1,{upgrade(t){t.createObjectStore("stories",{keyPath:"id"}).createIndex("by-savedAt","savedAt")}})),B}async function _(t){const e=await f(),n=await e.get("stories",t.id);n?await e.put("stories",{...n,...t,lastVisit:Date.now()}):await e.add("stories",{...t,savedAt:Date.now(),lastVisit:Date.now(),seenComments:[],readComments:[]})}async function $(t){await(await f()).delete("stories",t)}async function j(t){return(await f()).get("stories",t)}async function ot(){return(await(await f()).getAllFromIndex("stories","by-savedAt")).reverse()}async function W(t){return!!await(await f()).get("stories",t)}async function P(t,e,n,s){const o=await f(),r=await o.get("stories",t);if(!r)return;const i=new Set([...r.seenComments,...e]),c=new Set([...r.readComments,...n]);await o.put("stories",{...r,seenComments:Array.from(i),readComments:Array.from(c),totalComments:s,lastVisit:Date.now()})}async function q(t){const n=await(await f()).get("stories",t);if(!n)return null;const s=n.totalComments>0?Math.round(n.readComments.length/n.totalComments*100):0;return{seenComments:new Set(n.seenComments),readComments:new Set(n.readComments),totalComments:n.totalComments,readProgress:s}}const it=Object.freeze(Object.defineProperty({__proto__:null,getItem:j,getItems:ot,getProgress:q,isItemSaved:W,removeItem:$,saveItem:_,updateComments:P},Symbol.toStringTag,{value:"Module"})),at={matches:["*://news.ycombinator.com/*"],main(){const t=window.location.pathname==="/item",e=new URLSearchParams(window.location.search).get("id");t&&e&&lt(e),ct()}};async function ct(){const t=document.querySelectorAll("tr.athing:not(.comtr)");for(const e of t){const n=e.id;if(!n)continue;const s=e.querySelector("td.title:last-child"),o=s?.querySelector("a.titleline > a, span.titleline > a");if(!s||!o)continue;const r=document.createElement("button");r.className="hn-later-save-btn",r.dataset.storyId=n;const i=await W(n);r.classList.toggle("saved",i),r.textContent=i?"ðŸ“Œ":"ðŸ“",r.title=i?"Remove from Read Later":"Save for Later",r.addEventListener("click",async c=>{c.preventDefault(),c.stopPropagation(),await dt(r,o)}),s.insertBefore(r,s.firstChild)}}async function dt(t,e){const n=t.dataset.storyId;if(t.classList.contains("saved"))await $(n),t.classList.remove("saved"),t.textContent="ðŸ“",t.title="Save for Later";else{const r=e.textContent||"Untitled",i=e.href,c=`https://news.ycombinator.com/item?id=${n}`,u=(document.getElementById(n)?.nextElementSibling?.querySelector('a[href*="item?id="]')?.textContent||"").match(/(\d+)\s*comment/),d=u?parseInt(u[1],10):0;await _({id:n,title:r,url:i,hnUrl:c,totalComments:d}),t.classList.add("saved"),t.textContent="ðŸ“Œ",t.title="Remove from Read Later"}const o=await(await Promise.resolve().then(()=>it)).getItems();await y.storage.local.set({itemCount:o.length})}async function lt(t){if(!await j(t))return;const n=document.querySelectorAll("tr.athing.comtr");if(n.length===0)return;const s=await q(t),o=s?.seenComments||new Set,r=s?.readComments||new Set;n.forEach(m=>{const u=m.id;r.has(u)?m.classList.add("hn-later-read"):o.has(u)||m.classList.add("hn-later-new")}),ut(n,o,r),ht(n,r),window.location.hash==="#hn-later-unread"&&(K(n,r),history.replaceState(null,"",window.location.pathname+window.location.search));const i=[],c=[],a=new Map,l=new IntersectionObserver(m=>{m.forEach(u=>{const d=u.target.id;if(u.isIntersecting){if(o.has(d)||(o.add(d),i.push(d),u.target.classList.remove("hn-later-new")),!r.has(d)&&!a.has(d)){const p=window.setTimeout(()=>{r.add(d),c.push(d),u.target.classList.add("hn-later-read"),a.delete(d),mt(d)},500);a.set(d,p)}}else{const p=a.get(d);p&&(clearTimeout(p),a.delete(d))}})},{threshold:.5});n.forEach(m=>l.observe(m)),window.addEventListener("beforeunload",()=>{(i.length>0||c.length>0)&&P(t,i,c,n.length)}),setInterval(()=>{(i.length>0||c.length>0)&&(P(t,[...i],[...c],n.length),i.length=0,c.length=0)},5e3)}let g=null;const H=new Map;function ut(t,e,n){g=document.createElement("div"),g.className="hn-later-scrollbar";const s=document.documentElement.scrollHeight;t.forEach(o=>{const r=o.id,c=(o.getBoundingClientRect().top+window.scrollY)/s,a=document.createElement("div");a.className="hn-later-marker",a.dataset.commentId=r,n.has(r)?a.classList.add("read"):e.has(r)?a.classList.add("unread"):a.classList.add("new"),a.style.top=`${c*100}%`,a.addEventListener("click",()=>{o.scrollIntoView({behavior:"smooth",block:"center"})}),g.appendChild(a),H.set(r,a)}),document.body.appendChild(g)}function mt(t,e){const n=H.get(t);n&&(n.classList.remove("new","unread"),n.classList.add("read"))}function ht(t,e){const n=document.createElement("button");n.className="hn-later-jump-btn",n.innerHTML="â¬‡ï¸ Next Unread",n.title="Jump to next unread comment",n.addEventListener("click",()=>{K(t,e)}),document.body.appendChild(n);const s=()=>{const o=Array.from(t).some(r=>e.has(r.id)?!1:r.getBoundingClientRect().top>window.innerHeight);n.style.display=o?"block":"none"};window.addEventListener("scroll",s,{passive:!0}),s()}function K(t,e){for(const n of t)if(!e.has(n.id)){const s=n.getBoundingClientRect();if(s.top>window.innerHeight*.3||s.top<0){n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("hn-later-highlight"),setTimeout(()=>n.classList.remove("hn-later-highlight"),2e3);break}}}function v(t,...e){}const ft={debug:(...t)=>v(console.debug,...t),log:(...t)=>v(console.log,...t),warn:(...t)=>v(console.warn,...t),error:(...t)=>v(console.error,...t)};class x extends Event{constructor(e,n){super(x.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=n}static EVENT_NAME=A("wxt:locationchange")}function A(t){return`${y?.runtime?.id}:content:${t}`}function wt(t){let e,n;return{run(){e==null&&(n=new URL(location.href),e=t.setInterval(()=>{let s=new URL(location.href);s.href!==n.href&&(window.dispatchEvent(new x(s,n)),n=s)},1e3))}}}class b{constructor(e,n){this.contentScriptName=e,this.options=n,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}static SCRIPT_STARTED_MESSAGE_TYPE=A("wxt:content-script-started");isTopFrame=window.self===window.top;abortController;locationWatcher=wt(this);receivedMessageIds=new Set;get signal(){return this.abortController.signal}abort(e){return this.abortController.abort(e)}get isInvalid(){return y.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,n){const s=setInterval(()=>{this.isValid&&e()},n);return this.onInvalidated(()=>clearInterval(s)),s}setTimeout(e,n){const s=setTimeout(()=>{this.isValid&&e()},n);return this.onInvalidated(()=>clearTimeout(s)),s}requestAnimationFrame(e){const n=requestAnimationFrame((...s)=>{this.isValid&&e(...s)});return this.onInvalidated(()=>cancelAnimationFrame(n)),n}requestIdleCallback(e,n){const s=requestIdleCallback((...o)=>{this.signal.aborted||e(...o)},n);return this.onInvalidated(()=>cancelIdleCallback(s)),s}addEventListener(e,n,s,o){n==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),e.addEventListener?.(n.startsWith("wxt:")?A(n):n,s,{...o,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),ft.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:b.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(e){const n=e.data?.type===b.SCRIPT_STARTED_MESSAGE_TYPE,s=e.data?.contentScriptName===this.contentScriptName,o=!this.receivedMessageIds.has(e.data?.messageId);return n&&s&&o}listenForNewerScripts(e){let n=!0;const s=o=>{if(this.verifyScriptStartedEvent(o)){this.receivedMessageIds.add(o.data.messageId);const r=n;if(n=!1,r&&e?.ignoreFirstEvent)return;this.notifyInvalidated()}};addEventListener("message",s),this.onInvalidated(()=>removeEventListener("message",s))}}function It(){}function I(t,...e){}const gt={debug:(...t)=>I(console.debug,...t),log:(...t)=>I(console.log,...t),warn:(...t)=>I(console.warn,...t),error:(...t)=>I(console.error,...t)};return(async()=>{try{const{main:t,...e}=at,n=new b("content",e);return await t(n)}catch(t){throw gt.error('The content script "content" crashed on startup!',t),t}})()})();
content;
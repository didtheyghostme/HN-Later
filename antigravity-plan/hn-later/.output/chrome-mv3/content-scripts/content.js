var content=(function(){"use strict";function X(e){return e}const h=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;async function b(e){const t=await h.runtime.sendMessage({type:"SAVE_ITEM",item:e});if(!t.success)throw new Error(t.error)}async function C(e){const t=await h.runtime.sendMessage({type:"REMOVE_ITEM",storyId:e});if(!t.success)throw new Error(t.error)}async function T(e){const t=await h.runtime.sendMessage({type:"GET_ITEM",storyId:e});if(!t.success)throw new Error(t.error);return t.item}async function g(e){const t=await h.runtime.sendMessage({type:"IS_SAVED",storyId:e});if(!t.success)throw new Error(t.error);return t.saved}async function A(e,t,n){const o=await h.runtime.sendMessage({type:"UPDATE_CHECKPOINT",storyId:e,checkpointCommentId:t,totalComments:n});if(!o.success)throw new Error(o.error)}async function M(e){const t=await h.runtime.sendMessage({type:"GET_PROGRESS",storyId:e});if(!t.success)throw new Error(t.error);return t.progress}const $={matches:["*://news.ycombinator.com/*"],main(){const e=window.location.pathname==="/item",t=new URLSearchParams(window.location.search).get("id");e&&t&&(D(t),K(t)),e&&(document.body.classList.add("hn-later-item-page"),W()),R(),window.addEventListener("pageshow",n=>{n.persisted&&P()})}};async function R(){const e=document.querySelectorAll("tr.athing:not(.comtr)"),t=new URLSearchParams(window.location.search).get("id"),n=window.location.pathname==="/item";for(const o of e){const s=o.id;if(!s||n&&s===t)continue;const r=o.nextElementSibling?.querySelector("td.subtext");if(!r)continue;const a=r.querySelectorAll("a");if(!Array.from(a).find(m=>m.href.includes("item?id=")))continue;const d=document.createElement("a");d.href="#",d.className="hn-later-save-link",d.dataset.storyId=s;const c=await g(s);f(d,c),d.addEventListener("click",async m=>{m.preventDefault(),await H(d,o)});const u=document.createElement("span");u.className="hn-later-save-container",u.innerHTML=" | ",u.appendChild(d),r.appendChild(u)}}function f(e,t){e.textContent=t?"saved âœ“":"save",e.classList.toggle("saved",t)}async function P(){const e=document.querySelectorAll(".hn-later-save-link");for(const t of e){const n=t.dataset.storyId;if(!n)continue;const o=await g(n);f(t,o)}}async function H(e,t){const n=e.dataset.storyId;if(e.classList.contains("saved"))await C(n),f(e,!1);else{const i=t.querySelector("td.title:last-child")?.querySelector("a.titleline > a, span.titleline > a");if(!i)return;const r=i.textContent||"Untitled",a=i.href,l=`https://news.ycombinator.com/item?id=${n}`,m=(t.nextElementSibling?.querySelector('a[href*="item?id="]')?.textContent||"").match(/(\d+)\s*comment/),Q=m?parseInt(m[1],10):0;await b({id:n,title:r,url:a,hnUrl:l,totalComments:Q}),f(e,!0)}}async function D(e){await F(e);const t=await T(e);t&&N(e,t.checkpointTimestamp)}async function F(e){const t=document.querySelector("td.subtext");if(!t)return;const n=t.querySelectorAll("a"),o=n[n.length-1];if(!o)return;const s=document.createElement("a");s.href="#",s.className="hn-later-save-link",s.dataset.storyId=e;const i=await g(e);f(s,i),s.addEventListener("click",async a=>{a.preventDefault(),await U(s,e)});const r=document.createTextNode(" | ");o.after(r,s)}async function U(e,t){if(e.classList.contains("saved"))await C(t),f(e,!1),B();else{const o=document.querySelector(".titleline > a, .storylink"),s=o?.textContent||"Untitled",i=o?.href||window.location.href,r=window.location.href,l=document.querySelectorAll("tr.athing.comtr").length;await b({id:t,title:s,url:i,hnUrl:r,totalComments:l}),f(e,!0),N(t,null)}}function B(){document.querySelector(".hn-later-scrollbar")?.remove(),document.querySelector(".hn-later-buttons")?.remove(),document.querySelectorAll(".hn-later-new-label").forEach(e=>e.remove())}async function N(e,t){const n=document.querySelectorAll("tr.athing.comtr");if(n.length===0)return;const s=(await M(e))?.checkpointCommentId??null;if(t&&V(n,t),_(n,s),O(e,n),window.location.hash==="#hn-later-continue"&&s){const i=document.getElementById(s);i&&(i.scrollIntoView({behavior:"smooth",block:"start"}),history.replaceState(null,"",window.location.pathname+window.location.search))}}function V(e,t){console.log("[HN-Later] markNewComments called with checkpointTimestamp:",t,new Date(t).toISOString());let n=0;e.forEach((o,s)=>{const i=o.querySelector(".age"),r=o.querySelector(".age a");if(!i&&!r){s<3&&console.log(`[HN-Later] Comment ${o.id}: No .age or .age a found`);return}let a=i?.getAttribute("title")||r?.getAttribute("title");const l=o.querySelector(".age time");if(!a&&l&&(a=l.getAttribute("title")||l.getAttribute("datetime")),s<5&&console.log(`[HN-Later] Comment ${o.id}: ageSpan=${!!i}, ageLink=${!!r}, titleAttr="${a}"`),!a)return;const d=a.split(" ")[0],c=new Date(d).getTime();if(isNaN(c)){s<3&&console.log(`[HN-Later] Comment ${o.id}: Failed to parse timestamp "${d}" from "${a}"`);return}if(s<5&&console.log(`[HN-Later] Comment ${o.id}: commentTime=${c} (${new Date(c).toISOString()}), isNew=${c>t}`),c>t){n++;const u=document.createElement("span");u.className="hn-later-new-label",u.textContent="[NEW]";const m=r||i;m?.parentElement?.insertBefore(u,m.nextSibling),o.classList.add("hn-later-new")}}),console.log(`[HN-Later] Total new comments found: ${n}`)}let w=null;const x=new Map;function _(e,t){w=document.createElement("div"),w.className="hn-later-scrollbar";const n=document.createElement("div");n.className="hn-later-viewport",w.appendChild(n);const o=document.documentElement.scrollHeight;let s=t===null;e.forEach(r=>{const a=r.id,d=(r.getBoundingClientRect().top+window.scrollY)/o,c=document.createElement("div");c.className="hn-later-marker",c.dataset.commentId=a,r.classList.contains("hn-later-new")?c.classList.add("new"):s?c.classList.add("unread"):c.classList.add("read"),a===t&&(s=!0),c.style.top=`${d*100}%`,c.addEventListener("click",()=>{r.scrollIntoView({behavior:"smooth",block:"center"})}),w.appendChild(c),x.set(a,c)}),document.body.appendChild(w);const i=()=>{const r=window.scrollY,a=window.innerHeight,l=document.documentElement.scrollHeight;n.style.top=`${r/l*100}%`,n.style.height=`${a/l*100}%`};window.addEventListener("scroll",i,{passive:!0}),i()}function O(e,t){const n=document.createElement("div");n.className="hn-later-buttons";const o=document.createElement("button");o.className="hn-later-btn checkpoint",o.innerHTML="ðŸ“ Checkpoint",o.title="Save reading position",o.addEventListener("click",()=>Y(e,t));const s=document.createElement("button");s.className="hn-later-btn next-topic",s.innerHTML="â­ï¸ Next Topic",s.title="Jump to next top-level comment",s.addEventListener("click",()=>G(t)),n.appendChild(o),n.appendChild(s),document.body.appendChild(n)}let p=null;const q=new Map;function W(){const e=document.querySelectorAll("tr.athing.comtr");e.length!==0&&(p=document.createElement("div"),p.className="hn-later-collapse-overlay",document.body.appendChild(p),e.forEach(t=>{const n=t.id;if(!n)return;const o=document.createElement("button");o.className="hn-later-collapse-btn",o.textContent="â–¼",o.title="Collapse thread",o.dataset.commentId=n,o.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation();const i=t.querySelector(".togg");if(i){i.click();const r=i.textContent?.includes("+");o.textContent=r?"â–²":"â–¼",requestAnimationFrame(()=>v())}}),p.appendChild(o),q.set(n,o)}),v(),window.addEventListener("scroll",v,{passive:!0}),window.addEventListener("resize",v,{passive:!0}))}function v(){if(!p)return;const e=document.querySelector("#hnmain")||document.querySelector('table[width="85%"]'),t=e?e.getBoundingClientRect().right:window.innerWidth-100;q.forEach((n,o)=>{const s=document.getElementById(o);if(!s){n.style.display="none";return}const i=s.getBoundingClientRect();i.height===0||s.offsetParent===null?n.style.display="none":(n.style.display="flex",n.style.top=`${i.top}px`,n.style.left=`${t+8}px`)})}async function Y(e,t){let n=null;for(const o of t){const s=o.getBoundingClientRect();if(s.top>=0&&s.top<window.innerHeight/2){n=o;break}}if(!n){for(const o of t)if(o.getBoundingClientRect().bottom>0){n=o;break}}if(n){await A(e,n.id,t.length),L("ðŸ“ Checkpoint saved!");let o=!1;t.forEach(s=>{const i=x.get(s.id);i&&!i.classList.contains("new")&&(o?(i.classList.remove("read"),i.classList.add("unread")):(i.classList.remove("unread"),i.classList.add("read"))),s.id===n.id&&(o=!0)})}}function G(e){const t=window.scrollY;for(const n of e){const o=n.querySelector(".ind img");if((o?parseInt(o.getAttribute("width")||"0",10):0)===0&&n.getBoundingClientRect().top+window.scrollY>t+100){n.scrollIntoView({behavior:"smooth",block:"start"});break}}}function L(e){let t=document.querySelector(".hn-later-toast");t||(t=document.createElement("div"),t.className="hn-later-toast",document.body.appendChild(t)),t.textContent=e,t.classList.add("show"),setTimeout(()=>t?.classList.remove("show"),2e3)}function K(e){document.addEventListener("keydown",async t=>{if((t.metaKey||t.ctrlKey)&&t.shiftKey&&t.key.toLowerCase()==="s")if(t.preventDefault(),t.stopPropagation(),await g(e)){await C(e),L("ðŸ“š Removed from saved");const o=document.querySelector(".hn-later-save-link");o&&(o.textContent="save",o.classList.remove("saved")),document.querySelector(".hn-later-scrollbar")?.remove(),document.querySelector(".hn-later-buttons")?.remove()}else{const o=document.querySelector(".titleline > a, .storylink"),s=o?.textContent||"Untitled",i=o?.href||window.location.href,r=window.location.href,a=document.querySelectorAll("tr.athing.comtr");await b({id:e,title:s,url:i,hnUrl:r,totalComments:a.length}),L("ðŸ“Œ Saved for later (Cmd+Shift+S)");const l=document.querySelector(".hn-later-save-link");l&&(l.textContent="saved âœ“",l.classList.add("saved")),await T(e)&&!document.querySelector(".hn-later-scrollbar")&&window.location.reload()}})}function S(e,...t){}const z={debug:(...e)=>S(console.debug,...e),log:(...e)=>S(console.log,...e),warn:(...e)=>S(console.warn,...e),error:(...e)=>S(console.error,...e)};class k extends Event{constructor(t,n){super(k.EVENT_NAME,{}),this.newUrl=t,this.oldUrl=n}static EVENT_NAME=I("wxt:locationchange")}function I(e){return`${h?.runtime?.id}:content:${e}`}function J(e){let t,n;return{run(){t==null&&(n=new URL(location.href),t=e.setInterval(()=>{let o=new URL(location.href);o.href!==n.href&&(window.dispatchEvent(new k(o,n)),n=o)},1e3))}}}class y{constructor(t,n){this.contentScriptName=t,this.options=n,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}static SCRIPT_STARTED_MESSAGE_TYPE=I("wxt:content-script-started");isTopFrame=window.self===window.top;abortController;locationWatcher=J(this);receivedMessageIds=new Set;get signal(){return this.abortController.signal}abort(t){return this.abortController.abort(t)}get isInvalid(){return h.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(t){return this.signal.addEventListener("abort",t),()=>this.signal.removeEventListener("abort",t)}block(){return new Promise(()=>{})}setInterval(t,n){const o=setInterval(()=>{this.isValid&&t()},n);return this.onInvalidated(()=>clearInterval(o)),o}setTimeout(t,n){const o=setTimeout(()=>{this.isValid&&t()},n);return this.onInvalidated(()=>clearTimeout(o)),o}requestAnimationFrame(t){const n=requestAnimationFrame((...o)=>{this.isValid&&t(...o)});return this.onInvalidated(()=>cancelAnimationFrame(n)),n}requestIdleCallback(t,n){const o=requestIdleCallback((...s)=>{this.signal.aborted||t(...s)},n);return this.onInvalidated(()=>cancelIdleCallback(o)),o}addEventListener(t,n,o,s){n==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),t.addEventListener?.(n.startsWith("wxt:")?I(n):n,o,{...s,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),z.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:y.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(t){const n=t.data?.type===y.SCRIPT_STARTED_MESSAGE_TYPE,o=t.data?.contentScriptName===this.contentScriptName,s=!this.receivedMessageIds.has(t.data?.messageId);return n&&o&&s}listenForNewerScripts(t){let n=!0;const o=s=>{if(this.verifyScriptStartedEvent(s)){this.receivedMessageIds.add(s.data.messageId);const i=n;if(n=!1,i&&t?.ignoreFirstEvent)return;this.notifyInvalidated()}};addEventListener("message",o),this.onInvalidated(()=>removeEventListener("message",o))}}function tt(){}function E(e,...t){}const j={debug:(...e)=>E(console.debug,...e),log:(...e)=>E(console.log,...e),warn:(...e)=>E(console.warn,...e),error:(...e)=>E(console.error,...e)};return(async()=>{try{const{main:e,...t}=$,n=new y("content",t);return await e(n)}catch(e){throw j.error('The content script "content" crashed on startup!',e),e}})()})();
content;